<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Comp Image Scraper</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        color: #333;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
      }

      h1 {
        color: #0056b3;
        text-align: center;
        margin-top: 20px;
      }

      .form-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        height: 33%;
        width: 100%;
        margin-top: 40px;
      }

      form {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 100%;
        box-sizing: border-box;
      }

      label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
      }

      input[type="text"] {
        width: calc(100% - 22px);
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }

      button {
        background-color: #0056b3;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
      }

      button:hover {
        background-color: #004494;
      }

      #response {
        margin-top: 20px;
        font-size: 16px;
        text-align: center;
      }

      .spinner {
        margin: 0 auto;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #0056b3;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #imageGrid {
        display: grid;
        grid-template-columns: repeat(4, 2in);
        gap: 10px;
        margin-top: 20px;
      }

      .image-item {
        position: relative;
        width: 2in;
        height: 2in;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid #ccc;
        border-radius: 4px;
      }

      .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .copy-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 86, 179, 0.8);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 4px;
        display: none;
        cursor: pointer;
      }

      .image-item:hover .copy-button {
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>Comp Image Scraper</h1>
    <div class="form-container">
      <form id="scrapeForm">
        <label for="url">Enter Apartments.com URL to scrape:</label>
        <input
          type="text"
          id="url"
          name="url"
          value="https://www.apartments.com/the-eli-winter-springs-winter-springs-fl/c4vvq4e/"
          required
        />
        <button type="submit">Scrape</button>
      </form>
    </div>
    <div id="response"></div>
    <button id="openImagesButton" style="display: none; margin-top: 20px">
      Open Images in Browser
    </button>
    <div id="imageGrid"></div>

    <script>
      document
        .getElementById("scrapeForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const url = document.getElementById("url").value;
          const responseElement = document.getElementById("response");
          const imageGrid = document.getElementById("imageGrid");
          const openImagesButton = document.getElementById("openImagesButton");

          responseElement.innerHTML =
            '<div class="spinner"></div> Processing...';
          imageGrid.innerHTML = "";
          openImagesButton.style.display = "none";

          try {
            const response = await fetch("/scrape", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ url }),
            });
            const data = await response.json();
            if (data.success) {
              responseElement.textContent = "Scraping complete.";
              openImagesButton.style.display = "block";
              openImagesButton.onclick = async () => {
                const updatedUrls = data.images.map((imageUrl) =>
                  imageUrl.replace("/113/", "/116/")
                );
                await fetch("/open-images", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ images: updatedUrls }),
                });
              };

              data.images.forEach((imageUrl) => {
                const updatedUrl = imageUrl.replace("/113/", "/116/");
                const imgDiv = document.createElement("div");
                imgDiv.classList.add("image-item");

                const imgElement = document.createElement("img");
                imgElement.src = updatedUrl;

                const copyButton = document.createElement("button");
                copyButton.classList.add("copy-button");
                copyButton.textContent = "Copy";
                copyButton.onclick = async () => {
                  try {
                    const response = await fetch(updatedUrl);
                    const blob = await response.blob();

                    // Convert image to PNG using a canvas
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    const img = new Image();
                    img.src = URL.createObjectURL(blob);
                    img.onload = async () => {
                      canvas.width = img.width;
                      canvas.height = img.height;
                      ctx.drawImage(img, 0, 0);
                      canvas.toBlob(async (blob) => {
                        const item = new ClipboardItem({ "image/png": blob });
                        await navigator.clipboard.write([item]);
                        alert("Image copied to clipboard!");
                      }, "image/png");
                    };
                  } catch (error) {
                    alert("Failed to copy image: " + error.message);
                  }
                };

                imgDiv.appendChild(imgElement);
                imgDiv.appendChild(copyButton);
                imageGrid.appendChild(imgDiv);
              });
            } else {
              responseElement.textContent = `Error: ${data.message}`;
            }
          } catch (error) {
            responseElement.textContent = `Error: ${error.message}`;
          }
        });
    </script>
  </body>
</html>
